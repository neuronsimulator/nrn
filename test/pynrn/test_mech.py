import sys
import numpy as np
from neuron import h, gui
from math import cos, sin, fabs


def test_linmech_pendulum():

    cmat = h.Matrix(2, 2, 2).ident()

    gmat = h.Matrix(2, 2, 2)
    gmat.setval(0, 1, -1)
    gmat.setval(1, 0, 1)  # not needed unless experimenting with z2 below

    y = h.Vector(2)
    y0 = h.Vector(2)
    b = h.Vector(2)

    def callback():
        z1 = y.x[0]
        z2 = -fabs(cos(z1))  # jacobian element is db[1]/dy[0]
        z2 = 0
        gmat.setval(1, 0, z2)
        b.x[1] = -sin(z1) + z1 * z2

    nlm = h.LinearMechanism(callback, cmat, gmat, y, y0, b)

    dummy = h.Section()
    trajec = h.Vector()
    tvec = h.Vector()
    trajec.record(y._ref_x[0])
    tvec.record(h._ref_t)

    h.tstop = 50

    def prun(theta0, omega0):
        y0.x[0] = theta0
        y0.x[1] = omega0
        h.run()

    h.dt /= 10
    h.cvode.atol(1e-5)
    h.cvode_active(1)
    prun(0, 1.9999)  # 2.0001 will keep it rotating
    assert np.allclose(
        tvec.to_python(),
        [
            0.0,
            5.590449466222787e-06,
            1.1180898932445574e-05,
            2.2361797864891148e-05,
            4.4723595729782296e-05,
            8.944719145956459e-05,
            0.00017889438291912918,
            0.00035778876583825837,
            0.0007155775316765167,
            0.0014311550633530335,
            0.002862310126706067,
            0.005724620253412134,
            0.011449240506824268,
            0.022898481013648535,
            0.04579696202729707,
            0.0686954430409456,
            0.09159392405459414,
            0.11449240506824268,
            0.16028936709553976,
            0.20150663292010712,
            0.24272389874467448,
            0.28394116456924184,
            0.3251584303938092,
            0.36637569621837657,
            0.40759296204294393,
            0.4488102278675113,
            0.49002749369207865,
            0.5312447595166461,
            0.5724620253412134,
            0.6136792911657807,
            0.6961138228149154,
            0.7785483544640501,
            0.8609828861131849,
            0.9434174177623196,
            1.0258519494114542,
            1.1082864810605888,
            1.1907210127097234,
            1.273155544358858,
            1.3555900760079926,
            1.4380246076571273,
            1.5204591393062619,
            1.6028936709553965,
            1.685328202604531,
            1.7677627342536657,
            1.8501972659028003,
            1.932631797551935,
            2.0150663292010695,
            2.097500860850204,
            2.1799353924993388,
            2.2623699241484734,
            2.344804455797608,
            2.4272389874467426,
            2.5921080507450123,
            2.7569771140432815,
            2.9218461773415507,
            3.08671524063982,
            3.251584303938089,
            3.4164533672363584,
            3.5813224305346276,
            3.746191493832897,
            3.911060557131166,
            4.075929620429435,
            4.2407986837277045,
            4.405667747025974,
            4.570536810324243,
            4.735405873622512,
            4.900274936920781,
            5.065144000219051,
            5.23001306351732,
            5.559751190113859,
            5.856515504050744,
            6.153279817987629,
            6.450044131924514,
            6.746808445861399,
            7.043572759798284,
            7.340337073735169,
            7.637101387672054,
            7.933865701608939,
            8.230630015545824,
            8.527394329482709,
            8.824158643419594,
            9.120922957356479,
            9.417687271293364,
            9.714451585230249,
            10.011215899167134,
            10.307980213104019,
            10.529137361936204,
            10.711624955469206,
            10.894112549002209,
            11.058351383181911,
            11.222590217361613,
            11.370405168123344,
            11.503438623808902,
            11.63647207949446,
            11.769505535180018,
            11.902538990865576,
            12.022269100982578,
            12.130026200087881,
            12.227007589282653,
            12.323988978477425,
            12.420970367672197,
            12.51795175686697,
            12.614933146061741,
            12.711914535256513,
            12.808895924451285,
            12.89617917472658,
            12.983462425001875,
            13.07074567527717,
            13.158028925552465,
            13.24531217582776,
            13.332595426103055,
            13.41987867637835,
            13.507161926653644,
            13.59444517692894,
            13.681728427204234,
            13.76901167747953,
            13.856294927754824,
            13.94357817803012,
            14.030861428305414,
            14.118144678580709,
            14.205427928856004,
            14.292711179131299,
            14.379994429406594,
            14.467277679681889,
            14.554560929957184,
            14.641844180232479,
            14.729127430507774,
            14.816410680783068,
            14.903693931058363,
            14.990977181333658,
            15.078260431608953,
            15.165543681884248,
            15.340110182434838,
            15.514676682985428,
            15.689243183536018,
            15.863809684086608,
            16.038376184637197,
            16.212942685187787,
            16.387509185738377,
            16.562075686288967,
            16.736642186839557,
            16.911208687390147,
            17.085775187940737,
            17.260341688491327,
            17.434908189041916,
            17.609474689592506,
            17.784041190143096,
            17.958607690693686,
            18.133174191244276,
            18.307740691794866,
            18.656873692896045,
            19.006006693997225,
            19.355139695098405,
            19.669359396089465,
            19.983579097080526,
            20.297798798071586,
            20.612018499062646,
            20.926238200053707,
            21.240457901044767,
            21.554677602035827,
            21.868897303026888,
            22.183117004017948,
            22.4659147349099,
            22.748712465801855,
            23.03151019669381,
            23.242215577086995,
            23.418152840845927,
            23.59409010460486,
            23.7524336419879,
            23.91077717937094,
            24.053286363015676,
            24.195795546660413,
            24.324053811940676,
            24.452312077220938,
            24.5805703425012,
            24.696002781253437,
            24.79989197613045,
            24.903781171007463,
            24.997281446396773,
            25.090781721786083,
            25.184281997175393,
            25.277782272564703,
            25.371282547954014,
            25.464782823343324,
            25.548933071193705,
            25.633083319044086,
            25.717233566894468,
            25.80138381474485,
            25.88553406259523,
            25.96968431044561,
            26.053834558295993,
            26.137984806146374,
            26.222135053996755,
            26.306285301847137,
            26.390435549697518,
            26.4745857975479,
            26.55873604539828,
            26.64288629324866,
            26.727036541099043,
            26.811186788949424,
            26.895337036799805,
            26.979487284650187,
            27.063637532500568,
            27.14778778035095,
            27.23193802820133,
            27.316088276051712,
            27.400238523902093,
            27.484388771752474,
            27.568539019602856,
            27.652689267453237,
            27.73683951530362,
            27.905140011004377,
            28.073440506705136,
            28.241741002405895,
            28.410041498106654,
            28.578341993807413,
            28.746642489508172,
            28.91494298520893,
            29.08324348090969,
            29.25154397661045,
            29.41984447231121,
            29.588144968011967,
            29.756445463712726,
            29.924745959413485,
            30.093046455114244,
            30.261346950815003,
            30.429647446515762,
            30.59794794221652,
            30.76624843791728,
            31.1028494293188,
            31.439450420720316,
            31.776051412121834,
            32.0789923043832,
            32.38193319664457,
            32.684874088905936,
            32.987814981167304,
            33.29075587342867,
            33.59369676569004,
            33.89663765795141,
            34.19957855021278,
            34.502519442474146,
            34.805460334735514,
            35.10840122699688,
            35.38104803003211,
            35.65369483306734,
            35.92634163610257,
            36.12162160582328,
            36.28630384774271,
            36.45098608966214,
            36.61566833158157,
            36.76388234930905,
            36.91209636703653,
            37.045488982991266,
            37.178881598946,
            37.31227421490073,
            37.41932537297504,
            37.526376531049344,
            37.62272257331622,
            37.71906861558309,
            37.81541465784996,
            37.91176070011684,
            38.00810674238371,
            38.10445278465058,
            38.200798826917456,
            38.28751026495764,
            38.37422170299782,
            38.460933141038005,
            38.54764457907819,
            38.63435601711837,
            38.721067455158554,
            38.80777889319874,
            38.89449033123892,
            38.9812017692791,
            39.067913207319286,
            39.15462464535947,
            39.24133608339965,
            39.328047521439835,
            39.41475895948002,
            39.5014703975202,
            39.588181835560384,
            39.67489327360057,
            39.76160471164075,
            39.84831614968093,
            39.935027587721116,
            40.0217390257613,
            40.10845046380148,
            40.195161901841665,
            40.28187333988185,
            40.36858477792203,
            40.455296215962214,
            40.5420076540024,
            40.62871909204258,
            40.80214196812295,
            40.975564844203326,
            41.1489877202837,
            41.32241059636407,
            41.495833472444446,
            41.66925634852482,
            41.84267922460519,
            42.016102100685565,
            42.18952497676594,
            42.36294785284631,
            42.536370728926684,
            42.70979360500706,
            42.88321648108743,
            43.0566393571678,
            43.23006223324818,
            43.40348510932855,
            43.57690798540892,
            43.750330861489296,
            44.097176613650035,
            44.444022365810774,
            44.79086811797151,
            45.10302929491618,
            45.41519047186085,
            45.727351648805524,
            46.039512825750194,
            46.351674002694864,
            46.663835179639534,
            46.975996356584204,
            47.288157533528874,
            47.600318710473545,
            47.881263769723745,
            48.162208828973945,
            48.443153888224145,
            48.662410696291204,
            48.847456526684425,
            49.03250235707765,
            49.19904360443155,
            49.36558485178546,
            49.515471974403965,
            49.65037038476063,
            49.78526879511729,
            49.92016720547395,
            50.0,
        ],
    )
    assert np.allclose(
        trajec.to_python(),
        [
            3.9998e-09,
            1.1184339687149406e-05,
            2.2364679573599845e-05,
            4.472535934378272e-05,
            8.94467188631265e-05,
            0.00017888943770795636,
            0.0003577748739005421,
            0.0007155457343254412,
            0.0014310873595710315,
            0.0028621698453705816,
            0.0057243286997101005,
            0.011448597471802388,
            0.022896743551350626,
            0.04578990494829947,
            0.09155120850042694,
            0.1372628978343297,
            0.18290236322478678,
            0.22844641139858618,
            0.3191642244010304,
            0.4002591850137079,
            0.48069475648243537,
            0.5603459009811067,
            0.6390949245589187,
            0.7168314662904008,
            0.7934518221860417,
            0.8688612162012992,
            0.9429737602139306,
            1.0157121061799872,
            1.0870074312115725,
            1.156799567898482,
            1.2916764514527737,
            1.420030788913723,
            1.5416761917772641,
            1.6565377228240887,
            1.7646361361217866,
            1.866072134196245,
            1.9610111161795813,
            2.049668690146612,
            2.1322974621761435,
            2.2091755822705093,
            2.2805971852252007,
            2.3468645672052437,
            2.408281869918474,
            2.465150100494165,
            2.5177633437317084,
            2.566405996845601,
            2.61135083396957,
            2.652857724676105,
            2.6911728697144666,
            2.726528447528145,
            2.7591425796822495,
            2.7892195335047614,
            2.842512327471481,
            2.8877804230383775,
            2.926208526686642,
            2.9588138890877222,
            2.9864671882056637,
            3.0099114001673235,
            3.0297788158948453,
            3.0466065688377455,
            3.060850526587714,
            3.0728972544466564,
            3.0830741046941244,
            3.091657790128897,
            3.0988817702839944,
            3.1049425900578442,
            3.1100052234485007,
            3.114207521901764,
            3.11766392046976,
            3.1226964963851858,
            3.1254419357581282,
            3.1267558881314024,
            3.1267559296636196,
            3.125441651199884,
            3.1226955089741613,
            3.1182733769529696,
            3.1117830120541887,
            3.102648853435905,
            3.0900608198830652,
            3.072902964528757,
            3.049655746977867,
            3.0182638203108287,
            2.975959716812034,
            2.9190331334924604,
            2.842537892871012,
            2.739940136499428,
            2.641534868297385,
            2.5428507410502617,
            2.4253746882377736,
            2.3010309109008977,
            2.1565932903959717,
            2.007463356015039,
            1.8563794894400112,
            1.6883423059602982,
            1.5027716087994192,
            1.2995995203665724,
            1.1021869095351613,
            0.9135776347756968,
            0.735955481778984,
            0.5520403879533756,
            0.3632098698510903,
            0.17104938263313108,
            -0.022705930835200602,
            -0.21624688875964018,
            -0.4077746087376707,
            -0.5770153936290384,
            -0.7421106440247017,
            -0.9020702107485229,
            -1.0560666706094082,
            -1.2034463992547337,
            -1.3437301164486448,
            -1.4766042513880218,
            -1.6019056544014654,
            -1.7196024346430994,
            -1.829773134085663,
            -1.9325857613911106,
            -2.028277802133603,
            -2.117138065832301,
            -2.1994909061327834,
            -2.2756829750761423,
            -2.3460723978805325,
            -2.4110201412371577,
            -2.470883326148469,
            -2.5260102244280236,
            -2.5767366619460232,
            -2.623383556324165,
            -2.6662553500271864,
            -2.7056391433718745,
            -2.741804367518734,
            -2.775002863133891,
            -2.805469253252958,
            -2.833421522252477,
            -2.882577025220476,
            -2.9239093282377553,
            -2.9586439448623354,
            -2.987820085551874,
            -3.01231662130376,
            -3.0328748539727144,
            -3.0501185514307294,
            -3.064571756793473,
            -3.076674337154111,
            -3.0867951223369987,
            -3.095242828009279,
            -3.102275217746328,
            -3.1081068831993495,
            -3.112915813977781,
            -3.1168488414447677,
            -3.1200260865889553,
            -3.1225445872538207,
            -3.1244812508761073,
            -3.1268283929129566,
            -3.127356410450096,
            -3.1261321932394828,
            -3.123415008170406,
            -3.1188917631823863,
            -3.1121103954946028,
            -3.1023943752955274,
            -3.088776779181996,
            -3.069903941152083,
            -3.0439011097609603,
            -3.0081894154924855,
            -2.95923946839337,
            -2.89993018119529,
            -2.82137248091427,
            -2.71750922328262,
            -2.6191346185159454,
            -2.52016808453582,
            -2.403161086701237,
            -2.280113218080865,
            -2.138044343563086,
            -1.9921761897333325,
            -1.8278016017389096,
            -1.6631266650068304,
            -1.4821082142348792,
            -1.2847525197749263,
            -1.0936557285772515,
            -0.9115453295390127,
            -0.7209307560525244,
            -0.5432624148081124,
            -0.3610899261006614,
            -0.1758392442485537,
            0.010935320643561177,
            0.19761353921232103,
            0.382579364595391,
            0.5463073446410982,
            0.7063650650124546,
            0.8618376117588881,
            1.011947461404508,
            1.1560658940967794,
            1.2937157171870757,
            1.424566128213056,
            1.5484215812938378,
            1.665206843734515,
            1.7749500676248566,
            1.8777652047221323,
            1.9738347895803603,
            2.0633939163207398,
            2.1467159694828686,
            2.224100352714205,
            2.2958622137313576,
            2.362324044139978,
            2.4238089896604795,
            2.4806356781631806,
            2.5331143471621727,
            2.5815440466466155,
            2.6262107129057517,
            2.66738593994195,
            2.705326302307958,
            2.740273104250513,
            2.7724524495579215,
            2.802075546664523,
            2.8544265697082203,
            2.8987381957900538,
            2.93622287767493,
            2.9679173240624,
            2.99470529242704,
            3.017337968836666,
            3.0364521962665045,
            3.052586975433397,
            3.066198115604313,
            3.0776707712369475,
            3.0873299607440954,
            3.095449467803466,
            3.102259480006174,
            3.1079531171612507,
            3.1126919111203715,
            3.1166103481824896,
            3.119819639116989,
            3.122410860118362,
            3.126016633091293,
            3.1278400030940827,
            3.128091343805191,
            3.1270032538492827,
            3.1245692176196567,
            3.120562435333817,
            3.114610954140485,
            3.1061643660836014,
            3.094442379362471,
            3.0783620266267806,
            3.0564382120824276,
            3.0266490162155937,
            2.986254491038882,
            2.931556609702091,
            2.8660303578574426,
            2.7801749890240943,
            2.66791523083531,
            2.5671006806171177,
            2.466098027518945,
            2.3481240886120043,
            2.210816782422117,
            2.0687199917514483,
            1.90734605907468,
            1.7444455441549056,
            1.5640559628058293,
            1.365924284291331,
            1.194318834543378,
            1.012084342910062,
            0.8397572582849062,
            0.6605403671190679,
            0.47564637741304744,
            0.28651578098826086,
            0.09477124860398875,
            -0.09784728284442223,
            -0.28956022907125,
            -0.4598892728724057,
            -0.6268891747840566,
            -0.7894896276459294,
            -0.9467649639674688,
            -1.0979524813596973,
            -1.2424601507071504,
            -1.379864216959172,
            -1.5098986735882782,
            -1.6324392860797192,
            -1.7474845559413388,
            -1.8551354095965966,
            -1.9555749814417704,
            -2.0490495990520734,
            -2.1358517512007396,
            -2.2163054129688864,
            -2.2907537688945663,
            -2.3595492011907586,
            -2.4230453457612056,
            -2.481590982291888,
            -2.5355254921172032,
            -2.585175608243465,
            -2.6308532049174858,
            -2.6728539130203472,
            -2.711456382894668,
            -2.7469220433312294,
            -2.7794952297636777,
            -2.809403579497838,
            -2.8368586147934094,
            -2.885178762745372,
            -2.925853909463492,
            -2.960075011437267,
            -2.9888528910718164,
            -3.013043242691208,
            -3.0333685814172213,
            -3.050437565394131,
            -3.0647621621981234,
            -3.076772633531618,
            -3.0868302126477607,
            -3.0952376663323866,
            -3.1022481694271278,
            -3.108072847607987,
            -3.1128871529378,
            -3.116836157045263,
            -3.120038888800911,
            -3.122591883486982,
            -3.124572082375366,
            -3.1270361244512697,
            -3.127730324368403,
            -3.1267408478448426,
            -3.124318354681984,
            -3.120202219085208,
            -3.113986357107964,
            -3.105058713266275,
            -3.092542444173162,
            -3.075209574686478,
            -3.051360479825024,
            -3.0186596302059727,
            -2.973914107745732,
            -2.919787057833164,
            -2.848196053211262,
            -2.753654980664094,
            -2.6594537463651444,
            -2.5627523995830996,
            -2.4472944205376743,
            -2.3247295811565936,
            -2.181945833596746,
            -2.0341020557334817,
            -1.8839223491736543,
            -1.7164572768217512,
            -1.5310300180694378,
            -1.4127408191584063,
        ],
    )
