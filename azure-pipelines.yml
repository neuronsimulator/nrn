#=============================================================================
# Azure Pipeline settings
#=============================================================================

# Nightly build master for pypi upload
schedules:
- cron: "0 0 * * *"
  branches:
    include:
    - master
  always: true

# Auto cancel old PR builds
pr:
  autoCancel: true
# TODO : https://github.com/neuronsimulator/nrn/issues/1063
#  paths:
#    exclude:
#      - docs
#      - README.md

# Trigger build for certain branches only
trigger:
- master
- release/*

stages:
  - stage: BuildTestDeploy
    jobs:

    - job: 'ManyLinuxWheels'
      timeoutInMinutes: 45
      pool:
        vmImage: 'ubuntu-20.04'
      strategy:
        matrix:
          Python39:
            python.version: '3.9'
      steps:

      # Secure files documentation:
      #   https://docs.microsoft.com/en-us/azure/devops/pipelines/library/secure-files?view=azure-devops
      #   NOTE: when uploading new secure files, access must be permitted from the Azure pipeline interface (check message there)
      - task: DownloadSecureFile@1
        name: mpt_headersSF
        displayName: 'Download mpt_headers secure file'
        inputs:
          secureFile: 'mpt_headears.2.21.tar.gz'

      # Note that mpt headers must be mounted in the docker imager under `/nrnwheel/mpt`
      # This path is checked by `packaging/python/build_wheels.bash` when run in the image.
      - script: |
          sudo mkdir -p /opt/nrnwheel/mpt
          sudo tar -zxf $(mpt_headersSF.secureFilePath) --directory /opt/nrnwheel/mpt
          docker run --rm \
            -w /root/nrn \
            -v $PWD:/root/nrn \
            -v /opt/nrnwheel/mpt:/nrnwheel/mpt \
            -e NEURON_NIGHTLY_TAG \
            -e NRN_NIGHTLY_UPLOAD \
            -e NRN_RELEASE_UPLOAD \
            -e SETUPTOOLS_SCM_PRETEND_VERSION \
            -e NRN_BUILD_FOR_UPLOAD=1 \
            'neuronsimulator/neuron_wheel:latest-x86_64' \
            packaging/python/build_wheels.bash linux $(python.version) coreneuron
        displayName: 'Building ManyLinux Wheel'

      - script: |
          sudo apt update
          sudo apt install -y mpich openmpi-bin libopenmpi-dev libmpich-dev
        displayName: 'Install Test System Depdendencies'

      - template: ci/azure-wheel-test-upload.yml


  - stage: Final
    jobs:
      - job: AzureDropURL
        pool:
          vmImage: 'ubuntu-20.04'
        condition: eq(variables['Build.Reason'], 'PullRequest')
        steps:
          - checkout: none
          - script: |
              export AZURE_DROP_URL=`curl -v 'https://dev.azure.com/neuronsimulator/nrn/_apis/build/builds/$(Build.BuildId)/artifacts?artifactName=drop' | jq -r '.resource.downloadUrl'`
              echo "Setting dropurl to $AZURE_DROP_URL"
              echo "##vso[task.setvariable variable=dropurl]$AZURE_DROP_URL"
            displayName: 'Resolve Azure drop URL'
              
          - task: GitHubComment@0
            continueOnError: true
            inputs:
              gitHubConnection: 'neuronsimulator'
              repositoryName: '$(Build.Repository.Name)'
              comment: |
                ✔️ $(system.pullRequest.sourceCommitId) -> [Azure artifacts URL]($(dropurl))
