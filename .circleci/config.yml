version: 2.1

orbs:
  python: circleci/python@3.0.0

jobs:
  manylinux2014-aarch64:

    parameters:
      NRN_PYTHON_VERSION_MINOR:
        type: string
      NRN_NIGHTLY_UPLOAD:
        type: string

    machine:
      image: default

    resource_class: arm.medium

    steps:
      - run:
          name: Test manylinux AArch64 wheel
          command: |
            sudo apt update
            sudo apt install -t software-properties-common
            sudo add-apt-repository -y ppa:deadsnakes/ppa
            sudo apt update
            # install mpi dependencies
            sudo apt install -y mpich openmpi-bin libopenmpi-dev libmpich-dev
            # install Python from deadsnakes
            sudo apt install -y python3.<< parameters.NRN_PYTHON_VERSION_MINOR >>

            export PYTHON_EXE=$(which python3.<< parameters.NRN_PYTHON_VERSION_MINOR >>)

            



workflows:

  build-workflow:
    jobs:
      - manylinux2014-aarch64:
          filters:
            branches:
              only:
                - /release\/.*/
                - /circleci\/.*/
          matrix:
            parameters:
              NRN_PYTHON_VERSION_MINOR: ["13"]
              NRN_NIGHTLY_UPLOAD: ["false"]

  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - manylinux2014-aarch64:
          matrix:
            parameters:
              NRN_PYTHON_VERSION_MINOR: ["9", "10", "11", "12", "13"]
              NRN_NIGHTLY_UPLOAD: ["true"]
