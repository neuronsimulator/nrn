<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running a simulation &mdash; NEURON  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=6933245a" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/design-tabs.js?v=f930bc37"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Examples" href="examples.html" />
    <link rel="prev" title="Getting CoreNEURON" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            NEURON
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Building:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake_doc/index.html">CMake Build Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/developer.html">Developer Builds</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/index.html">Training videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../courses/exercises2018.html">NEURON Course Exercises</a></li>
<li class="toctree-l1"><a class="reference external" href="https://neuron.yale.edu/phpBB">The NEURON forum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications about NEURON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications-using-neuron.html">Publications using NEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NEURON scripting:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../scripting.html">Running Python and HOC scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hoc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherscripting.html">Other scripting languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rxd-tutorials/index.html">Python RXD tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">CoreNEURON</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="compatibility.html">CoreNEURON Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html">Getting CoreNEURON</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running a simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-mod-files">Building MOD files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enabling-coreneuron">Enabling CoreNEURON</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NMODLanguage:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nmodl/index.html">NMODLanguage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C/C++ API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Removed Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../removed_features.html">Removed Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">NEURON 8.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-1">NEURON 8.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-0">NEURON 8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#contributors">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#feedback-help">Feedback / Help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEURON</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">CoreNEURON</a></li>
      <li class="breadcrumb-item active">Running a simulation</li>
<li class="wy-breadcrumbs-aside">
    
    
</li>

      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/coreneuron/running-a-simulation.rst.txt" rel="nofollow"> View page source</a>
      </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-a-simulation">
<span id="coreneuron-running-a-simulation"></span><h1>Running a simulation<a class="headerlink" href="#running-a-simulation" title="Link to this heading"></a></h1>
<p>This section describes how to use CoreNEURON to simulate a NEURON model.</p>
<section id="building-mod-files">
<h2>Building MOD files<a class="headerlink" href="#building-mod-files" title="Link to this heading"></a></h2>
<p>As in a typical NEURON workflow, you can now use <code class="docutils literal notranslate"><span class="pre">nrnivmodl</span></code> to translate MOD files.
In order to enable CoreNEURON support, you must set the <code class="docutils literal notranslate"><span class="pre">-coreneuron</span></code> flag.
Make sure any necessary modules (compilers, CUDA, MPI etc.) are loaded before you run <code class="docutils literal notranslate"><span class="pre">nrnivmodl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nrnivmodl</span> <span class="o">-</span><span class="n">coreneuron</span> <span class="o">&lt;</span><span class="n">directory</span> <span class="n">containing</span> <span class="o">.</span><span class="n">mod</span> <span class="n">files</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Even if you don’t have additional MOD files (i.e. you are relying on
builtin NEURON MOD files) <strong>you still need to use</strong> <code class="docutils literal notranslate"><span class="pre">nrnivmodl</span>
<span class="pre">-coreneuron</span></code> <strong>to generate a CoreNEURON library</strong>.
For example, you can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nrnivmodl</span> <span class="o">-</span><span class="n">coreneuron</span> <span class="o">.</span>
</pre></div>
</div>
<p>With the command above, NEURON will create a <code class="docutils literal notranslate"><span class="pre">x86_64/special</span></code> binary
that is linked to CoreNEURON (here <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> is the architecture name
of your system).</p>
<p>If you see any compilation error then one of the MOD files might be incompatible with CoreNEURON.
In this case, you should first consult the <a class="reference internal" href="compatibility.html#coreneuron-compatibility"><span class="std std-ref">CoreNEURON Compatibility</span></a> section, and if that does not provide a clear explanation then you should <a class="reference external" href="https://github.com/neuronsimulator/nrn/issues">open an issue</a> with an example of your MOD file.</p>
</section>
<section id="enabling-coreneuron">
<span id="id1"></span><h2>Enabling CoreNEURON<a class="headerlink" href="#enabling-coreneuron" title="Link to this heading"></a></h2>
<p>With CoreNEURON, existing NEURON models can be run with minimal changes.
For a given NEURON model, the following steps are usually required:</p>
<p>First, enable CoreNEURON:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neuron</span> <span class="kn">import</span> <span class="n">coreneuron</span>
<span class="n">coreneuron</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>If your build supports GPU execution then you may also enable this at runtime:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">coreneuron</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>If you enable GPU execution you must launch your simulation using the</strong> <code class="docutils literal notranslate"><span class="pre">special</span></code> <strong>binary!</strong>
This is explained in more detail below.</p>
</div>
<p>Finally, use <code class="docutils literal notranslate"><span class="pre">psolve</span></code> to run the simulation after initialization:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">h</span><span class="o">.</span><span class="n">stdinit</span><span class="p">()</span>
<span class="n">pc</span><span class="o">.</span><span class="n">psolve</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span>
</pre></div>
</div>
<p>With the above steps, NEURON will build the model in memory and transfer it to CoreNEURON for simulation.
At the end of the simulation CoreNEURON will, by default, transfer spikes, voltages, state variables, NetCon weights, all <code class="docutils literal notranslate"><span class="pre">Vector.record</span></code>, and most GUI trajectories to NEURON.
These variables can be recorded using the regular NEURON API (e.g. <a class="reference internal" href="../python/programming/math/vector.html#Vector.record" title="Vector.record"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Vector.record()</span></code></a> or <a class="reference internal" href="../python/modelspec/programmatic/network/parcon.html#ParallelContext.spike_record" title="ParallelContext.spike_record"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ParallelContext.spike_record()</span></code></a>).</p>
<p>If you are primarily using HOC then before calling <code class="docutils literal notranslate"><span class="pre">psolve</span></code> you can enable CoreNEURON as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// make sure NEURON is compiled with Python
if (!nrnpython(&quot;from neuron import coreneuron&quot;)) {
  printf(&quot;NEURON not compiled with Python support\n&quot;)
  return
}

// access coreneuron module via Python object
py_obj = new PythonObject()
py_obj.coreneuron.enable = 1
</pre></div>
</div>
<p>Once you have adapted your model by making the changes described above
then you can execute your model like a normal NEURON simulation.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">num_process</span><span class="o">&gt;</span> <span class="n">nrniv</span> <span class="o">-</span><span class="n">mpi</span> <span class="o">-</span><span class="n">python</span> <span class="n">your_script</span><span class="o">.</span><span class="n">py</span> <span class="c1"># python</span>
<span class="n">mpiexec</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">num_process</span><span class="o">&gt;</span> <span class="n">nrniv</span> <span class="o">-</span><span class="n">mpi</span> <span class="n">your_script</span><span class="o">.</span><span class="n">hoc</span>        <span class="c1"># hoc</span>
</pre></div>
</div>
<p>Alternatively, instead of <code class="docutils literal notranslate"><span class="pre">nrniv</span></code> you can use the <code class="docutils literal notranslate"><span class="pre">special</span></code> binary generated by <code class="docutils literal notranslate"><span class="pre">nrnivmodl</span></code> command.
Note that for GPU execution you <strong>must</strong> use the <code class="docutils literal notranslate"><span class="pre">special</span></code> binary to launch your simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">num_process</span><span class="o">&gt;</span> <span class="n">x86_64</span><span class="o">/</span><span class="n">special</span> <span class="o">-</span><span class="n">mpi</span> <span class="o">-</span><span class="n">python</span> <span class="n">your_script</span><span class="o">.</span><span class="n">py</span> <span class="c1"># python</span>
<span class="n">mpiexec</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">num_process</span><span class="o">&gt;</span> <span class="n">x86_64</span><span class="o">/</span><span class="n">special</span> <span class="o">-</span><span class="n">mpi</span> <span class="n">your_script</span><span class="o">.</span><span class="n">hoc</span>        <span class="c1"># hoc</span>
</pre></div>
</div>
<p>This is because the GPU-enabled build is statically linked <a class="reference external" href="https://forums.developer.nvidia.com/t/clarification-on-using-openacc-in-a-shared-library/136279/27">to avoid issues with OpenACC</a>, so <code class="docutils literal notranslate"><span class="pre">python</span></code> and <code class="docutils literal notranslate"><span class="pre">nrniv</span></code> cannot dynamically load CoreNEURON.</p>
<p>As CoreNEURON is used as a library under NEURON, it will use the same number of MPI ranks as NEURON.
Also, if you enable threads using <a class="reference internal" href="../python/modelspec/programmatic/network/parcon.html#ParallelContext.nthread" title="ParallelContext.nthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ParallelContext.nthread()</span></code></a> then CoreNEURON will internally use the same number of OpenMP threads.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may need to replace mpiexec with an MPI launcher supported on your system, e.g. <code class="docutils literal notranslate"><span class="pre">srun</span></code> or <code class="docutils literal notranslate"><span class="pre">mpirun</span></code>.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Getting CoreNEURON" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="examples.html" class="btn btn-neutral float-right" title="Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Duke, Yale and the Blue Brain Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>