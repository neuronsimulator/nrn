<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch runs with bulletin board parallelization &mdash; NEURON  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=6933245a" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/design-tabs.js?v=f930bc37"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            NEURON
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Building:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake_doc/index.html">CMake Build Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/developer.html">Developer Builds</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/index.html">Training videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercises2018.html">NEURON Course Exercises</a></li>
<li class="toctree-l1"><a class="reference external" href="https://neuron.yale.edu/phpBB">The NEURON forum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications about NEURON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications-using-neuron.html">Publications using NEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NEURON scripting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scripting.html">Running Python and HOC scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hoc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherscripting.html">Other scripting languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rxd-tutorials/index.html">Python RXD tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coreneuron/index.html">CoreNEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NMODLanguage:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nmodl/index.html">NMODLanguage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C/C++ API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Removed Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../removed_features.html">Removed Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">NEURON 8.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-1">NEURON 8.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-0">NEURON 8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#contributors">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#feedback-help">Feedback / Help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEURON</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Batch runs with bulletin board parallelization</li>
<li class="wy-breadcrumbs-aside">
    
    
</li>

      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/courses/batch_runs_bulletin_board_parallelization.rst.txt" rel="nofollow"> View page source</a>
      </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="batch-runs-with-bulletin-board-parallelization">
<span id="batch-runs-bulletin-board-parallelization"></span><h1>Batch runs with bulletin board parallelization<a class="headerlink" href="#batch-runs-with-bulletin-board-parallelization" title="Link to this heading"></a></h1>
<p>Sooner or later most modelers find it necessary to grind out a large number of simulations, varying one or more parameters from one run to the next. The purpose of this exercise is to show you how bulletin board parallelization can speed this up.</p>
<p>This exercise could be done at several levels of complexity. Most challenging and rewarding, but also most time consuming, would be for you to develop all code from scratch. But learning by example also has its virtues, so we provide complete serial and parallel implementations that you can examine and work with.</p>
<blockquote>
<div><p><em>The following instructions assume that you are using a Mac or PC, with at least NEURON 7.1 under UNIX/Linux, or NEURON 7.2 under macOS or MSWin. For UNIX, Linux, or macOS, be sure MPICH 2 or OpenMPI is installed. For Windows, be sure Microsoft MPI is installed. If you are using a workstation cluster or parallel supercomputer, some details will differ, so ask the system administrator how to get your NEURON source code (.py, .ses, .mod files) to where the hosts can use them, how to compile .mod files, and what commands are used to manage simulations.</em></p>
</div></blockquote>
<section id="physical-system">
<h2>Physical system<a class="headerlink" href="#physical-system" title="Link to this heading"></a></h2>
<p>You have a cell with an excitable dendritic tree. You can inject a steady depolarizing current into the soma and observe membrane potential in the dendrite. Your goal is to find the relationship between the amplitude of the current applied at the soma, and the spike frequency at the distal end of the dendritic tree.</p>
</section>
<section id="computational-implementation">
<h2>Computational implementation<a class="headerlink" href="#computational-implementation" title="Link to this heading"></a></h2>
<section id="the-model-cell">
<h3>The model cell<a class="headerlink" href="#the-model-cell" title="Link to this heading"></a></h3>
<p>The model cell is a ball and stick with these properties:</p>
<p><strong>soma</strong></p>
<blockquote>
<div><table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>L</p></td>
<td><p>10 μm</p></td>
</tr>
<tr class="row-even"><td><p>diam</p></td>
<td><p>3.1831 μm  (area 100 μm<sup>2</sup>)</p></td>
</tr>
<tr class="row-odd"><td><p>cm</p></td>
<td><p>1 μF/cm<sup>2</sup></p></td>
</tr>
<tr class="row-even"><td><p>Ra</p></td>
<td><p>100 ohm * cm</p></td>
</tr>
<tr class="row-odd"><td><p>nseg</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>kinetics</p></td>
<td><p>full Hodgkin-Huxley</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>dend</strong></p>
<blockquote>
<div><table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>L</p></td>
<td><p>1000 μm</p></td>
</tr>
<tr class="row-even"><td><p>diam</p></td>
<td><p>2 μm</p></td>
</tr>
<tr class="row-odd"><td><p>cm</p></td>
<td><p>1 μF/cm<sup>2</sup></p></td>
</tr>
<tr class="row-even"><td><p>Ra</p></td>
<td><p>100 ohm * cm</p></td>
</tr>
<tr class="row-odd"><td><p>nseg</p></td>
<td><p>25</p></td>
</tr>
<tr class="row-even"><td><p>kinetics</p></td>
<td><p>reduced Hodgkin-Huxley (all conductances <code class="docutils literal notranslate"><span class="pre">/=</span> <span class="pre">2</span></code>)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The implementation of this model is in <a class="reference download internal" download="" href="../_downloads/94a404d93181d07649b4556b63518bcd/cell.py"><code class="xref download docutils literal notranslate"><span class="pre">cell.py</span></code></a>.</p>
</section>
<section id="code-development-strategy">
<h3>Code development strategy<a class="headerlink" href="#code-development-strategy" title="Link to this heading"></a></h3>
<p>Before trying to set up a program that runs multiple simulations, it is useful to have a program that executes a single simulation. This is helpful for exploring the properties of the model and collecting information needed to guide the development of a batch simulation program.</p>
<p>The next step is to create a program that performs serial execution of multiple simulations, i.e. executes them one after another. In addition to generating simulation results, it is useful for this program to report a measure of computational performance. For this example the measure will be the total time required to run all simulations and save results. The simulation results will be needed to verify that the parallel implementation is working properly. The performance measure will help us gauge the success of our efforts, and indicate whether we should look for additional ways to shorten run times.</p>
<p>The final step is to create a parallel implementation of the batch program. This should be tested by comparing its simulation results and performance against those of the serial batch program in order to detect errors or performance deficiencies that should be corrected.</p>
<p>In accordance with this development strategy, we provide the following three programs. For each program there is a brief description, plus one or more examples of usage. There are also links to each program’s source code and code walkthroughs, which may be helpful in completing one of this exercise’s assignments.</p>
<p>Finally, there is a fourth program for plotting results that have been saved to a file, but more about that later.</p>
</section>
<section id="initonerun-py">
<h3>initonerun.py<a class="headerlink" href="#initonerun-py" title="Link to this heading"></a></h3>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Link to this heading"></a></h4>
<p>Executes one simulation with a specified stimulus.</p>
<p>Displays response and reports spike frequency.</p>
</section>
<section id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">initonerun</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>A new simulation can be launched by entering the command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">onerun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>at the <code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> prompt, where x is a number that specifies the stimulus current amplitude in nA.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">onerun</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="source">
<h4>Source<a class="headerlink" href="#source" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../_downloads/ed16e3c8c1470ee19a1e62c9e753e9ab/initonerun.py"><code class="xref download docutils literal notranslate"><span class="pre">initonerun.py</span></code></a></p></li>
<li><p><a class="reference internal" href="bulletin_board_walkthrough.html#initonerun-walkthrough"><span class="std std-ref">code walkthrough</span></a></p></li>
</ul>
</section>
</section>
<section id="initbatser-py">
<h3>initbatser.py<a class="headerlink" href="#initbatser-py" title="Link to this heading"></a></h3>
<section id="id1">
<h4>Description<a class="headerlink" href="#id1" title="Link to this heading"></a></h4>
<p>Executes a batch of simulations, one at a time, in which stimulus amplitude increases from run to run.</p>
<p>Then saves results, reports performance, and optionally plots an f-i graph.</p>
</section>
<section id="id2">
<h4>Usage<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>Either</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">initbatser</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>or (to see the graph):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">i</span> <span class="n">initbatser</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>Source<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../_downloads/cf2c5830c5ad41484304f7789fa497c7/initbatser.py"><code class="xref download docutils literal notranslate"><span class="pre">initbatser.py</span></code></a></p></li>
<li><p><a class="reference internal" href="bulletin_board_walkthrough.html#initbatser-walkthrough"><span class="std std-ref">code walkthrough</span></a></p></li>
</ul>
</section>
</section>
<section id="initbatpar-py">
<h3>initbatpar.py<a class="headerlink" href="#initbatpar-py" title="Link to this heading"></a></h3>
<section id="id4">
<h4>Description<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<p>Performs the same task as <code class="file docutils literal notranslate"><span class="pre">initbatser.py</span></code>, i.e. executes a batch of simulations, but does it serially or in parallel, depending on how the program is launched.</p>
<p>Parallel execution uses NEURON’s bulletin board.</p>
</section>
<section id="id5">
<h4>Usage<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>Serial execution: <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">initbatpar.py</span></code>
runs simulations one after another on a single processor, i.e. serially. Parallel execution: <code class="docutils literal notranslate"><span class="pre">mpiexec</span> <span class="pre">-n</span> <span class="pre">N</span> <span class="pre">python</span> <span class="pre">initbatpar.py</span></code>
launches N processes that carry out the simulations. On a multicore PC or Mac, parallel execution with N equal to the number of cores can reduce total run time to about 1/N of the run time required by initbatser.py, serial execution of initbatpar.py, or parallel execution of initbatpar.py with N = 1.</p>
</section>
<section id="id6">
<h4>Source<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../_downloads/0a19e20757f5692c28fd4e5400036a3d/initbatpar.py"><code class="xref download docutils literal notranslate"><span class="pre">initbatpar.py</span></code></a></p></li>
<li><p><a class="reference internal" href="bulletin_board_walkthrough.html#initbatpar-walkthrough"><span class="std std-ref">code walkthrough</span></a></p></li>
</ul>
</section>
</section>
</section>
<section id="things-to-do">
<h2>Things to do<a class="headerlink" href="#things-to-do" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Run a few simulations with initonerun.py just to see how the cell responds to injected current. You might try to find the smallest and largest stimuli that elicit repetitive dendritic spiking.</p></li>
<li><p>Compare results produced by serial and parallel simulations, to verify that parallelization hasn’t broken anything. For example (on Linux and macOS):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>python initbatser.py
mv fi.dat fiser.dat
python initbatpar.py
mv fi.dat finompi.dat
mpiexec -n 4 python initbatpar.py
mv fi.dat fimpi4.dat
cmp fiser.dat finompi.dat
cmp fiser.dat fimpi4.dat
</pre></div>
</div>
<p>Instead of <code class="docutils literal notranslate"><span class="pre">cmp</span></code>, MSWin users will have to use <code class="docutils literal notranslate"><span class="pre">fc</span></code> in a “Command Prompt” (cmd) or Power Shell window.</p>
</li>
<li><p>Evaluate and compare performance of the serial and parallel programs.
Here are results of some tests I ran:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NEURON 7.5 (266b5a0) 2017-05-22 under Windows Subsystem for Linux
on a quad core desktop.
initbatser     6.16 s
initbatpar
without MPI  6.03
with MPI            speedup
n = 1        6.03   1 (performance baseline)
    2        3.41   1.77
    3        2.62   2.30
    4        2.05   2.94
</pre></div>
</div>
</li>
<li><p>Make a copy of initbatpar.py and edit it, inserting print calls that reveal the sequence of execution, i.e. which processor is doing what. These statements should report whatever you think would help you understand program flow. Here are some suggestions for things you might want to report:</p>
<ul class="simple">
<li><p>the identity of the host process (i.e. the <code class="docutils literal notranslate"><span class="pre">pc.id</span></code>)</p></li>
<li><p>the name of the proc or func that is being entered or exited</p></li>
<li><p>the value that is being passed or returned</p></li>
<li><p>the index of the simulation that is being run</p></li>
<li><p>anything else that you think might illuminate this dark little corner of computational neuroscience</p></li>
</ul>
<p>Focus on the parts of the program that are involved in the master’s principal function (posting jobs and gathering results), and the workers’ principal function (entering, executing, and exiting <code class="docutils literal notranslate"><span class="pre">fi</span></code>).</p>
<p>After inserting the print calls, change NRUNS to 3 or 4, then run a serial simulation and see what happens.</p>
<p>Next run parallel simulations with -n 1, 2, 3 or 4 and see what happens. Do the monitor reports make sense?</p>
</li>
<li><p>Examine an f-i curve from data saved to one of the dat files.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-i<span class="w"> </span>initplotfi.py
</pre></div>
</div>
<p>then use its file browser to select one of the dat files.</p>
<p>Examine <a class="reference download internal" download="" href="../_downloads/ee8b4c0ae936a3e4d41e3c8ec2ece6d9/initplotfi.py"><code class="xref download docutils literal notranslate"><span class="pre">initplotfi.py</span></code></a> to see how it takes advantage of procs that are built into NEURON’s standard run library <code class="file docutils literal notranslate"><span class="pre">stdlib.hoc</span></code> (view the source code for this file on the NEURON GitHub repository at <a class="reference external" href="https://github.com/neuronsimulator/nrn/blob/master/share/lib/hoc/stdlib.hoc">https://github.com/neuronsimulator/nrn/blob/master/share/lib/hoc/stdlib.hoc</a>).</p>
</li>
</ol>
<div class="toctree-wrapper compound">
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Duke, Yale and the Blue Brain Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>